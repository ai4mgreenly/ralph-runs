#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/story-get - Read a single pipeline story from GitHub Issues
#
# Usage: story-get [--repo OWNER/REPO] <number>
#
# Output: JSON {"ok": true, "number": ..., "title": ..., "body": ..., "goals": [...]}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'optparse'

def has_label?(labels, target)
  labels.any? do |label|
    name = label.is_a?(Hash) ? label['name'] : label.to_s
    name == target
  end
end

def find_linked_goals(story_number, nwo: nil)
  cmd = [
    'gh', 'issue', 'list',
    '--label', 'pipeline,goal',
    '--json', 'number,title,labels,body',
    '--limit', '100',
    '--state', 'all'
  ]
  cmd += ['--repo', nwo] if nwo

  stdout = IO.popen(cmd, err: '/dev/null', &:read)
  return [] if $?.exitstatus != 0

  issues = JSON.parse(stdout) rescue []

  issues.select do |issue|
    body = issue['body'] || ''
    body.match?(/Story:\s*##{story_number}\b/)
  end.map do |issue|
    {
      number: issue['number'],
      title: issue['title']
    }
  end
end

def main
  nwo = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: story-get [--repo OWNER/REPO] <number>

      Read a single pipeline story and its linked goals from GitHub Issues.

      Arguments:
        --repo    Optional. GitHub repo in OWNER/REPO format.
        number    GitHub Issue number (required)

      Output:
        JSON with fields: number, title, state, body, goals
        goals is an array of {number, title} for goals referencing this story.

      Examples:
        story-get 15
        story-get 15 --repo mgreenly/ikigai
    HELP

    opts.on('--repo=REPO', 'GitHub repo (OWNER/REPO)') { |r| nwo = r }
  end.parse!

  number = ARGV[0]&.to_i

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  cmd = ['gh', 'issue', 'view', number.to_s]
  cmd += ['--repo', nwo] if nwo
  cmd += ['--json', 'number,title,labels,body,state']

  stdout = IO.popen(cmd, err: '/dev/null', &:read)

  if $?.exitstatus != 0
    puts JSON.generate(ok: false, items: ["issue ##{number} not found"])
    exit 1
  end

  issue = JSON.parse(stdout) rescue nil

  unless issue
    puts JSON.generate(ok: false, items: ['could not parse gh output'])
    exit 1
  end

  labels = issue['labels'] || []

  unless has_label?(labels, 'story')
    puts JSON.generate(ok: false, items: ["##{number} is not a story"])
    exit 1
  end

  goals = find_linked_goals(number, nwo: nwo)

  puts JSON.generate(
    ok: true,
    number: issue['number'],
    title: issue['title'],
    state: issue['state'],
    body: issue['body'],
    goals: goals
  )
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
