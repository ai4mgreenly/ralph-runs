#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-spot-check - Approve or reject a goal after smoke test
#
# Usage: goal-spot-check [--repo OWNER/REPO] <number> approve
#        goal-spot-check [--repo OWNER/REPO] <number> reject --feedback "..."
#
# approve: swaps goal:spot-check → goal:done
# reject:  swaps goal:spot-check → goal:queued, adds feedback as comment
#
# Output: JSON {"ok": true, "number": <number>}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'optparse'

def main
  nwo = nil
  feedback = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: goal-spot-check [--repo OWNER/REPO] <number> approve
             goal-spot-check [--repo OWNER/REPO] <number> reject --feedback "..."

      Approve or reject a pipeline goal after human smoke test.

      Arguments:
        --repo OWNER/REPO   GitHub repo (optional)
        number              GitHub Issue number (required)
        action              One of: approve, reject (required)

      Flags:
        --feedback "..."    Reason for rejection (required with reject)

      What it does:
        approve: Removes goal:spot-check, adds goal:done.
        reject:  Removes goal:spot-check, adds goal:queued,
                 posts feedback as a comment for the next ralph run.

      Examples:
        goal-spot-check 42 approve
        goal-spot-check 42 reject --feedback "Widget doesn't render"
        goal-spot-check 42 approve --repo mgreenly/ikigai
    HELP

    opts.on('--repo=REPO', 'GitHub repo (OWNER/REPO)') { |r| nwo = r }
    opts.on('--feedback=TEXT', 'Reason for rejection') { |f| feedback = f }
  end.parse!

  number = ARGV[0]&.to_i
  action = ARGV[1]

  unless number && number > 0
    puts JSON.generate(ok: false, items: ['issue number is required'])
    exit 1
  end

  unless %w[approve reject].include?(action)
    puts JSON.generate(ok: false, items: ['action must be approve or reject'])
    exit 1
  end

  if action == 'reject' && (feedback.nil? || feedback.empty?)
    puts JSON.generate(ok: false, items: ['--feedback is required with reject'])
    exit 1
  end

  # Remove goal:spot-check
  cmd = ['gh', 'issue', 'edit', number.to_s, '--remove-label', 'goal:spot-check']
  cmd += ['--repo', nwo] if nwo
  system(*cmd, out: '/dev/null', err: '/dev/null')

  if action == 'approve'
    cmd = ['gh', 'issue', 'edit', number.to_s, '--add-label', 'goal:done']
    cmd += ['--repo', nwo] if nwo
    ok = system(*cmd, out: '/dev/null', err: '/dev/null')

    unless ok
      puts JSON.generate(ok: false, items: ["failed to update labels on ##{number}"])
      exit 1
    end

    story_try_close = File.join(File.dirname(File.realpath(__FILE__)), '..', 'story-try-close', 'run')
    stc_cmd = [story_try_close, number.to_s]
    stc_cmd += ['--repo', nwo] if nwo
    system(*stc_cmd, out: '/dev/null', err: '/dev/null')
  else
    # Re-queue
    cmd = ['gh', 'issue', 'edit', number.to_s, '--add-label', 'goal:queued']
    cmd += ['--repo', nwo] if nwo
    ok = system(*cmd, out: '/dev/null', err: '/dev/null')

    unless ok
      puts JSON.generate(ok: false, items: ["failed to update labels on ##{number}"])
      exit 1
    end

    # Post feedback as comment
    cmd = ['gh', 'issue', 'comment', number.to_s, '--body', "Spot-check rejected:\n\n#{feedback}"]
    cmd += ['--repo', nwo] if nwo
    system(*cmd, out: '/dev/null', err: '/dev/null')
  end

  puts JSON.generate(ok: true, number: number)
  exit 0
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
