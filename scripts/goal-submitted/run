#!/usr/bin/env ruby
# frozen_string_literal: true

#
# scripts/goal-submitted - Transition a goal from running to submitted
#
# Usage: goal-submitted <id>
#
# Output: JSON {"ok": true}
# Exit code: 0 on success, 1 on failure
#

require 'json'
require 'net/http'
require 'optparse'

RALPH_PLANS_HOST = ENV.fetch('RALPH_PLANS_HOST')
RALPH_PLANS_PORT = ENV.fetch('RALPH_PLANS_PORT')

def main
  pr_num = nil

  OptionParser.new do |opts|
    opts.banner = <<~HELP
      Usage: goal-submitted <id> [--pr N]

      Transition a pipeline goal from running to submitted.

      Arguments:
        id    Goal ID (required)

      Options:
        --pr N    PR number to record on the goal (optional)

      What it does:
        Records the PR number (if provided) and transitions the goal from running to submitted.

      Output:
        JSON {"ok": true}

      Examples:
        goal-submitted 42
        goal-submitted 42 --pr 123
    HELP

    opts.on('--pr N', Integer, 'PR number to record') do |n|
      pr_num = n
    end
  end.parse!

  id = ARGV[0]&.to_i

  unless id && id > 0
    puts JSON.generate(ok: false, error: 'goal id is required')
    exit 1
  end

  # Record PR number if provided
  if pr_num
    pr_uri = URI("http://#{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}/goals/#{id}/pr")
    pr_req = Net::HTTP::Patch.new(pr_uri)
    pr_req['Content-Type'] = 'application/json'
    pr_req.body = JSON.generate(pr: pr_num)
    pr_resp = Net::HTTP.start(pr_uri.hostname, pr_uri.port) { |http| http.request(pr_req) }
    pr_result = JSON.parse(pr_resp.body)

    unless pr_result['ok']
      puts JSON.generate(pr_result)
      exit 1
    end
  end

  # Transition to submitted
  uri = URI("http://#{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}/goals/#{id}/submitted")
  req = Net::HTTP::Patch.new(uri)
  resp = Net::HTTP.start(uri.hostname, uri.port) { |http| http.request(req) }
  result = JSON.parse(resp.body)

  puts JSON.generate(result)
  exit(result['ok'] ? 0 : 1)
rescue Errno::ECONNREFUSED
  puts JSON.generate(ok: false, error: "cannot connect to ralph-plans at #{RALPH_PLANS_HOST}:#{RALPH_PLANS_PORT}")
  exit 1
end

if __FILE__ == $PROGRAM_NAME
  begin
    main
  rescue Interrupt
    exit 130
  end
end
